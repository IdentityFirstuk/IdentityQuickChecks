<#
    Shared Reporting Module for IdentityFirst QuickChecks
    Provides consistent JSON and HTML output across all modules
#>

function Export-IdentityReport {
    param(
        [Parameter(Mandatory)]
        [string]$ModuleName,
        
        [Parameter(Mandatory)]
        [string]$CheckName,
        
        [Parameter(Mandatory)]
        [object]$Data,
        
        [string]$OutputPath = "."
    )
    
    $timestamp = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
    $baseName = "$ModuleName-$CheckName-$timestamp"
    
    # Export JSON
    $jsonPath = Join-Path $OutputPath "$baseName.json"
    # Normalize data to an array and build report
    $dataArray = @($Data)
    $report = @{
        module = $ModuleName
        check = $CheckName
        timestamp = (Get-Date).ToString("o")
        count = ($dataArray | Measure-Object).Count
        data = $dataArray
    }
    $report | ConvertTo-Json -Depth 10 | Out-File -FilePath $jsonPath -Encoding UTF8
    
    # Export HTML
    $htmlPath = Join-Path $OutputPath "$baseName.html"
    $htmlContent = @"
<!DOCTYPE html>
<html>
<head>
    <title>IdentityFirst - $ModuleName Report</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #1a73e8; }
        h2 { color: #5f6368; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #1a73e8; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .meta { color: #666; font-size: 0.9em; margin-bottom: 20px; }
        .count { font-weight: bold; color: #1a73e8; }
    </style>
</head>
<body>
    <h1>IdentityFirst $ModuleName</h1>
    <div class="meta">
        <p><strong>Check:</strong> $CheckName</p>
        <p><strong>Generated:</strong> $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")</p>
        <p><strong>Records:</strong> <span class="count">$($report.count)</span></p>
    </div>
    <h2>Results</h2>
    TABLE_PLACEHOLDER
    <footer>
        <p><em>Generated by IdentityFirst QuickChecks. For full analysis, run IdentityHealthCheck.</em></p>
    </footer>
</body>
</html>
"@
    
    # Generate HTML table from data
    if ($dataArray -and ($dataArray | Measure-Object).Count -gt 0) {
        $htmlTable = "<table><tr>"
        # Build union of all property names for consistent columns
        $properties = ($dataArray | ForEach-Object { $_.PSObject.Properties.Name } | Sort-Object -Unique)
        foreach ($prop in $properties) {
            $htmlTable += "<th>$prop</th>"
        }
        $htmlTable += "</tr>"
        
        foreach ($item in $dataArray) {
            $htmlTable += "<tr>"
            foreach ($prop in $properties) {
                $value = $item.$prop
                if ($null -eq $value) { $value = "" }
                $htmlTable += "<td>$value</td>"
            }
            $htmlTable += "</tr>"
        }
        $htmlTable += "</table>"
        $htmlContent = $htmlContent.Replace("TABLE_PLACEHOLDER", $htmlTable)
    } else {
        $htmlContent = $htmlContent.Replace("TABLE_PLACEHOLDER", "<p>No results found.</p>")
    }
    
    $htmlContent | Out-File -FilePath $htmlPath -Encoding UTF8
    
    return @{
        JsonPath = $jsonPath
        HtmlPath = $htmlPath
        RecordCount = $report.count
    }
}

function Write-IdentityHeader {
    param(
        [string]$Title,
        [string]$Description
    )
    $obj = [PSCustomObject]@{
        Timestamp = (Get-Date).ToString("o")
        Level = 'Info'
        Message = $Title
        Description = $Description
        Type = 'Header'
    }
    Write-IFQC -InputObject $obj
}

function Write-IdentityResult {
    param(
        [int]$Count,
        [string]$Context = "results"
    )
    $level = if ($Count -gt 0) { 'Warning' } else { 'Info' }
    $msg = if ($Count -gt 0) { "Found $Count $Context" } else { 'No issues detected' }
    $obj = [PSCustomObject]@{
        Timestamp = (Get-Date).ToString("o")
        Level = $level
        Message = $msg
        Count = $Count
        Type = 'Result'
    }
    Write-IFQC -InputObject $obj
}

function Get-ReferToIHC {
    return @"

  ─────────────────────────────────────────────────────────────
  ℹ  For full analysis, governance review, and compliance 
     assessment, run IdentityHealthCheck.
  ─────────────────────────────────────────────────────────────
"@
}

Export-ModuleMember -Function Export-IdentityReport, Write-IdentityHeader, 
                            Write-IdentityResult, Get-ReferToIHC

# SIG # Begin signature block
# MIIJyAYJKoZIhvcNAQcCoIIJuTCCCbUCAQExDzANBglghkgBZQMEAgEFADB5Bgor
# BgEEAYI3AgEEoGswaTA0BgorBgEEAYI3AgEeMCYCAwEAAAQQH8w7YFlLCE63JNLG
# KX7zUQIBAAIBAAIBAAIBAAIBADAxMA0GCWCGSAFlAwQCAQUABCDKXggxAveWBdaC
# HoP1psp93ebeQVR9T8DJAHdls3IkQaCCBdYwggXSMIIDuqADAgECAhAxVnqog0nQ
# oULr1YncnW59MA0GCSqGSIb3DQEBCwUAMIGAMQswCQYDVQQGEwJHQjEXMBUGA1UE
# CAwOTm9ydGh1bWJlcmxhbmQxFzAVBgNVBAcMDk5vcnRodW1iZXJsYW5kMRowGAYD
# VQQKDBFJZGVudGl0eUZpcnN0IEx0ZDEjMCEGA1UEAwwaSWRlbnRpdHlGaXJzdCBD
# b2RlIFNpZ25pbmcwHhcNMjYwMTI5MjExMDU3WhcNMzEwMTI5MjEyMDU2WjCBgDEL
# MAkGA1UEBhMCR0IxFzAVBgNVBAgMDk5vcnRodW1iZXJsYW5kMRcwFQYDVQQHDA5O
# b3J0aHVtYmVybGFuZDEaMBgGA1UECgwRSWRlbnRpdHlGaXJzdCBMdGQxIzAhBgNV
# BAMMGklkZW50aXR5Rmlyc3QgQ29kZSBTaWduaW5nMIICIjANBgkqhkiG9w0BAQEF
# AAOCAg8AMIICCgKCAgEAtrU2HprgcHe9mxlmt5X72OsSk7cXDyUhoOAcLE9f4lS2
# rOx7VbZSMSi0r4lt8a/S5m/JIWCdYO+GrWZCgS2S73H3KNDszR5HDPbMhv+leoWA
# qLT7C0awpjcTnvWIDxnHyHHane/TNl3ehY9Jek5qrbiNgJDatV6SEYVFlK8Nk9kE
# 3TiveVvRKokNT2xY4/h1rohFCHnF+g7dCn06xAZwoGnFVlmPop3jItAlZdUQz3zR
# /xSNW01sQXgW6/TYd2VzXXuQihMQ3ikjoNGX1L8SlcV4ih2J+r2kSHjhkZ8c+wJE
# v2iiUHqpwmch31UwQOb4qklGKg1A+SAUGdf0cTTc6ApSFsqrol1euObreoy0zdAA
# k47NELuGhKA4N0Dk9Ar616JGFt/03s1waukNisnH/sk9PmPGUo9QtKH1IQpBtwWw
# uKel0w3MmgTwi2vBwfyh2/oTDkTfic7AT3+wh6O/9mFxxu2Fsq6VSlYRpSTSpgxF
# c/YsVlQZaueZs6WB6/HzftGzv1Mmz7is8DNnnhkADTEMj+NDo4wq+lUCE7XNDnnH
# KBN8MkDh4IljXVSkP/xwt4wLLd9g7oAOW91SDA2wJniyjSUy9c+auW3lbA8ybSfL
# TrQgZiSoepcCjW2otZIXrmDnJ7BtqmmiRff4CCacdJXxqNWdFnv6y7Yy6DQmECEC
# AwEAAaNGMEQwDgYDVR0PAQH/BAQDAgeAMBMGA1UdJQQMMAoGCCsGAQUFBwMDMB0G
# A1UdDgQWBBQBfqZy0Xp6lbG6lqI+cAlT7ardlTANBgkqhkiG9w0BAQsFAAOCAgEA
# IwBi/lJTGag5ac5qkMcnyholdDD6H0OaBSFtux1vPIDqNd35IOGYBsquL0BZKh8O
# AHiuaKbo2Ykevpn5nzbXDBVHIW+gN1yu5fWCXSezCPN/NgVgdH6CQ6vIuKNq4BVm
# E8AEhm7dy4pm4WPLqEzWT2fwJhnJ8JYBnPbuUVE8F8acyqG8l3QMcGICG26NWgGs
# A28YvlkzZsny+HAzLvmJn/IhlfWte1kGu0h0G7/KQG6hei5afsn0HxWHKqxI9JsG
# EF3SsMVQW3YJtDzAiRkNtII5k0PyywjrgzIGViVNOrKMT9dKlsTev6Ca/xQX13xM
# 0prtnvxiTXGtT031EBGXAUhOzvx2Hp1WFnZTEIJyX1J2qI+DQsPb9Y1jWcdGBwv3
# /m1nAHE7FpPGsSv+UIP3QQFD/j6nLl5zUoWxqAZMcV4K4t4WkPQjPAXzomoRaqc6
# toXHlXhKHKZ0kfAIcPCFlMwY/Rho82GiATIxHXjB/911VRcpv+xBoPCZkXDnsr9k
# /aRuPNt9DDSrnocJIoTtqIdel/GJmD0D75Lg4voUX9J/1iBuUzta2hoBA8fSVPS5
# 6plrur3Sn5QQG2kJt9I4z5LS3UZSfT+29+xJz7WSyp8+LwU7jaNUuWr3lpUnY2nS
# pohDlw2BFFNGT6/DZ0loRJrUMt58UmfdUX8FPB7uNuIxggNIMIIDRAIBATCBlTCB
# gDELMAkGA1UEBhMCR0IxFzAVBgNVBAgMDk5vcnRodW1iZXJsYW5kMRcwFQYDVQQH
# DA5Ob3J0aHVtYmVybGFuZDEaMBgGA1UECgwRSWRlbnRpdHlGaXJzdCBMdGQxIzAh
# BgNVBAMMGklkZW50aXR5Rmlyc3QgQ29kZSBTaWduaW5nAhAxVnqog0nQoULr1Ync
# nW59MA0GCWCGSAFlAwQCAQUAoIGEMBgGCisGAQQBgjcCAQwxCjAIoAKAAKECgAAw
# GQYJKoZIhvcNAQkDMQwGCisGAQQBgjcCAQQwHAYKKwYBBAGCNwIBCzEOMAwGCisG
# AQQBgjcCARUwLwYJKoZIhvcNAQkEMSIEIJ17MRyH+kVGODD5vziW9U0L4KE5/S3B
# /UClcczBklp7MA0GCSqGSIb3DQEBAQUABIICABQWgzoPNs4uVfukBvB/OFJN4ly9
# q7upTHeEDUvFWVGDaJ3XKWrbSAZYVO6dJYIDxn7feSX6da3/5QJdn6ATam814fip
# 0PyHT2ierKrrZGtvnAD6xIeL1xuu3SPIwwookUa/6DXbsgZE1AEVyCVO2XaaM5Cs
# hzi0+FiiPwGqaJ2WHMOJ2oT1ZhxzYPvOnS5TNRd+91I4NrdEK9dOQ4mC4J1Tp3lV
# +nKKe0RUHPH8zl0tHGhFRk36/3AsV6z7L98v+heprhVsv/XdjPQQm4MVeK+heMU8
# dFLTZ7NRrqdJEUPvmX14C7cx4ZdZ1e7anRh+r86fQ7mst4Z93OXhJIxgRBKqqnvF
# fiHocgDvN4PGspJLA3AHJCR/a6YnY4nHrU3jQOFMd/Frxsr7/xqC+3ianwig2wdH
# Y8C+qnP9tOUBkXrBl/aryV7nW7tdWK2UNLJoz+lbUQm2PSI6jW9fJGDtmXhwR/4x
# DPIiVm5gyOvQ/NR5fcpRjzLinM4T6WU3LZhvjs1+j9G+YPXlS0uZwK7Sj/+Gb3Ek
# COdbQg5wZ/moQZKfzu5KIk6DXStKx9nFiaLP3Z+OH9D5Pk+IARhxx01H/bRvNJ00
# 2YFUjHztGNOxr8atCKpU1gK4mNEnlaE6Jm95jguBFiUW2oN4NgHSBob/djYDWiAU
# PcxsNJiwB85Evejy
# SIG # End signature block
