<#
    Password Policy Drift Snapshot
    Identifies accounts bypassing default password policies (clean, read-only implementation)
#>

param(
    [string]$OutputPath = "."
)

function Write-Header($msg) { try { Write-IFQC -Level Info -Message $msg } catch { Write-Output $msg } }

Write-Header 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
Write-Header '  Password Policy Drift Snapshot'
Write-Header 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
Write-Header ''
Write-Header '  Identifying password policy exceptions...'
Write-Header ''

try {
    if (-not (Get-Module -ListAvailable -Name ActiveDirectory)) { throw 'ActiveDirectory module not available' }
    Import-Module ActiveDirectory -ErrorAction Stop
} catch {
    Write-IFQC -Level Error -Message 'ActiveDirectory module not available; run on a host with RSAT or DC access.'
    exit 1
}

# Get Fine-Grained Password Policies (FGPP)
try {
    $fgpp = Get-ADFineGrainedPasswordPolicy -Filter * -ErrorAction SilentlyContinue |
        Select-Object Name,MinPasswordLength,PasswordHistoryCount,ComplexityEnabled
} catch { $fgpp = $null }

if ($fgpp -and $fgpp.Count -gt 0) { $fgpp | Format-Table -AutoSize } else { Write-IFQC -Level Info -Message 'No fine-grained policies found (using domain policy)' }

# Query users (conservative default)
try {
    $users = Get-ADUser -Filter * -Properties PasswordNeverExpires,MemberOf,lastLogonTimestamp,Enabled,DisplayName -ErrorAction Stop
} catch {
    Write-IFQC -Level Error -Message "Failed to query AD users: $($_.Exception.Message)"
    exit 1
}

$weakPolicy = $users | Where-Object { $_.PasswordNeverExpires -eq $true } | ForEach-Object {
    [pscustomobject]@{
        SamAccountName = $_.SamAccountName
        DisplayName = $_.DisplayName
        Enabled = $_.Enabled
        LastLogon = if ($_.lastLogonTimestamp) { [DateTime]::FromFileTime($_.lastLogonTimestamp).ToString('yyyy-MM-dd') } else { 'Never' }
        MemberOfCount = if ($_.MemberOf) { ($_.MemberOf | Measure-Object).Count } else { 0 }
    }
}

Write-IFQC -Level Info -Message "Accounts with PasswordNeverExpires = True: $($weakPolicy.Count)"
if ($weakPolicy.Count -gt 0) { $weakPolicy | Format-Table -AutoSize }

# Privileged groups check
$privilegedGroups = @('Domain Admins','Enterprise Admins','Schema Admins','Administrators')
$privilegedUsers = @()
foreach ($g in $privilegedGroups) {
    try {
        $members = Get-ADGroupMember -Identity $g -ErrorAction Stop | Where-Object { $_.objectClass -eq 'user' }
        foreach ($m in $members) {
            try {
                $u = Get-ADUser -Identity $m.SamAccountName -Properties PasswordNeverExpires -ErrorAction Stop
                if ($u.PasswordNeverExpires) {
                    $privilegedUsers += [pscustomobject]@{ SamAccountName = $u.SamAccountName; Group = $g; PasswordNeverExpires = $true }
                }
            } catch { }
        }
    } catch { }
}

if ($privilegedUsers.Count -gt 0) {
    Write-IFQC -Level Warning -Message "Privileged accounts with PasswordNeverExpires: $($privilegedUsers.Count)"
    $privilegedUsers | Format-Table -AutoSize
} else { Write-IFQC -Level Success -Message 'No privileged accounts with PasswordNeverExpires found' }

# Export JSON report
$timestamp = Get-Date -Format 'yyyy-MM-dd_HH-mm-ss'
$jsonPath = Join-Path $OutputPath "PasswordPolicyDrift-$timestamp.json"
$report = [pscustomobject]@{
    check = 'Password Policy Drift Snapshot'
    timestamp = (Get-Date).ToString('o')
    fineGrainedPolicies = $fgpp
    weakPolicyAccounts = $weakPolicy
    privilegedWithWeakPolicy = $privilegedUsers
}

$report | ConvertTo-Json -Depth 10 | Out-File -FilePath $jsonPath -Encoding UTF8
Write-IFQC -Level Info -Message "Report saved: $jsonPath"

Write-IFQC -Level Info -Message 'Password exceptions exist. Review governance and remediate as needed.'
<#
    Password Policy Drift Snapshot
    Identifies accounts bypassing default password policies
#>

param(
    [string]$OutputPath = "."
)

Write-IFQC -Message "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -Level Info
Write-IFQC -Message "  Password Policy Drift Snapshot" -Level Info
Write-IFQC -Message "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -Level Info
Write-IFQC -Message "" -Level Info
Write-IFQC -Message "  Identifying password policy exceptions..." -Level Info
Write-IFQC -Message "" -Level Info

try {
    Import-Module ActiveDirectory -ErrorAction Stop
}
catch {
    Write-IFQC -Message "  âœ— ActiveDirectory module not available" -Level Error
    Write-IFQC -Message "  â„¹ Install RSAT AD tools or run on a Domain Controller" -Level Info
    exit 1
}

# Get Fine-Grained Password Policies
$fgpp = Get-ADFineGrainedPasswordPolicy -Filter * | 
    Select-Object Name,MinPasswordLength,PasswordHistoryCount,ComplexityEnabled

if ($fgpp) {
    $fgpp | Format-Table -AutoSize
} else {
    Write-IFQC -Message "     None configured (using default domain policy)" -Level Info
}
Write-IFQC -Message "" -Level Info

    )
# Find accounts with password never expires
    Write-Output "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    Write-Output "  Password Policy Drift Snapshot"
    Write-Output "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    Write-Output ""
    Write-Output "  Identifying password policy exceptions..."
    Write-Output ""
$users = Get-ADUser -Filter * -Properties PasswordNeverExpires,MemberOf,lastLogonTimestamp

$weakPolicy = $users | Where-Object {
    $_.PasswordNeverExpires -eq $true
} | Select-Object SamAccountName,Enabled,
        Write-Output "  âœ— ActiveDirectory module not available"
        Write-Output "  â„¹ Install RSAT AD tools or run on a Domain Controller"
            [DateTime]::FromFileTime($_.lastLogonTimestamp).ToString("yyyy-MM-dd")
        } else { "Never" }
    }},
    @{Name="MemberOf";Expression={ ($_.MemberOf | Measure-Object).Count }}

Write-IFQC -Message "  Accounts with PasswordNeverExpires = True:" -Level Info
if ($weakPolicy) {
    Write-IFQC -Message "  âš  Found $($weakPolicy.Count) accounts with password never expires" -Level Warning
    Write-IFQC -Message "" -Level Info
    $weakPolicy | Format-Table -AutoSize
} else {
    Write-IFQC -Message "     None configured (using default domain policy)" -Level Info
}

# Find privileged users with weak policy
$privilegedGroups = @("Domain Admins", "Enterprise Admins", "Schema Admins", "Administrators")
$privilegedUsers = @()

foreach ($group in $privilegedGroups) {
    try {
        $members = Get-ADGroupMember $group -ErrorAction Stop | 
            Where-Object objectClass -eq "user"
        foreach ($member in $members) {
            $user = Get-ADUser $member -Properties PasswordNeverExpires
            if ($user.PasswordNeverExpires) {
                $privilegedUsers += [PSCustomObject]@{
                    SamAccountName = $user.SamAccountName
                    Group = $group
                    PasswordNeverExpires = $true
                }
        Write-IFQC -Message "  âš  Found $($weakPolicy.Count) accounts with password never expires" -Level Warning
        Write-IFQC -Message "" -Level Info
        $weakPolicy | Format-Table -AutoSize
    catch { }
        Write-IFQC -Message "  âœ“ No accounts found with password never expires" -Level Success

if ($privilegedUsers) {
    Write-IFQC -Message "" -Level Info
    Write-IFQC -Message "  âš  Privileged accounts with password never expires:" -Level Warning
    $privilegedUsers | Format-Table -AutoSize
}

# Export report
$timestamp = Get-Date -Format "yyyy-MM-dd_HH-mm-ss"
$jsonPath = Join-Path $OutputPath "PasswordPolicyDrift-$timestamp.json"
$report = @{
    check = "Password Policy Drift Snapshot"
    timestamp = (Get-Date).ToString("o")
    fineGrainedPolicies = $fgpp
    weakPolicyAccounts = $weakPolicy
    privilegedWithWeakPolicy = $privilegedUsers
}
$report | ConvertTo-Json -Depth 10 | Out-File -FilePath $jsonPath -Encoding UTF8
Write-IFQC -Message "" -Level Info
Write-IFQC -Message "  ğŸ“„ Report saved: $jsonPath" -Level Info

Write-IFQC -Message "" -Level Info
Write-IFQC -Message "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -Level Info
Write-IFQC -Message "  â„¹  Password exceptions exist. Whether they're acceptable" -Level Info
Write-IFQC -Message "     requires governance review. Run IdentityHealthCheck." -Level Info
Write-IFQC -Message "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€" -Level Info
Write-IFQC -Message "" -Level Info
Write-IFQC -Message "  âš  Privileged accounts with password never expires:" -Level Warning
# SIG # Begin signature block
# MIIJyAYJKoZIhvcNAQcCoIIJuTCCCbUCAQExDzANBglghkgBZQMEAgEFADB5Bgor
# BgEEAYI3AgEEoGswaTA0BgorBgEEAYI3AgEeMCYCAwEAAAQQH8w7YFlLCE63JNLG
# KX7zUQIBAAIBAAIBAAIBAAIBADAxMA0GCWCGSAFlAwQCAQUABCCr61H7Xtur13Te
# e7P8W0/1rn506a/4FqIaWQwoCrFVsqCCBdYwggXSMIIDuqADAgECAhAxVnqog0nQ
# oULr1YncnW59MA0GCSqGSIb3DQEBCwUAMIGAMQswCQYDVQQGEwJHQjEXMBUGA1UE
# CAwOTm9ydGh1bWJlcmxhbmQxFzAVBgNVBAcMDk5vcnRodW1iZXJsYW5kMRowGAYD
# VQQKDBFJZGVudGl0eUZpcnN0IEx0ZDEjMCEGA1UEAwwaSWRlbnRpdHlGaXJzdCBD
# b2RlIFNpZ25pbmcwHhcNMjYwMTI5MjExMDU3WhcNMzEwMTI5MjEyMDU2WjCBgDEL
# MAkGA1UEBhMCR0IxFzAVBgNVBAgMDk5vcnRodW1iZXJsYW5kMRcwFQYDVQQHDA5O
# b3J0aHVtYmVybGFuZDEaMBgGA1UECgwRSWRlbnRpdHlGaXJzdCBMdGQxIzAhBgNV
# BAMMGklkZW50aXR5Rmlyc3QgQ29kZSBTaWduaW5nMIICIjANBgkqhkiG9w0BAQEF
# AAOCAg8AMIICCgKCAgEAtrU2HprgcHe9mxlmt5X72OsSk7cXDyUhoOAcLE9f4lS2
# rOx7VbZSMSi0r4lt8a/S5m/JIWCdYO+GrWZCgS2S73H3KNDszR5HDPbMhv+leoWA
# qLT7C0awpjcTnvWIDxnHyHHane/TNl3ehY9Jek5qrbiNgJDatV6SEYVFlK8Nk9kE
    Write-Output "  ğŸ“„ Report saved: $jsonPath"
# /xSNW01sQXgW6/TYd2VzXXuQihMQ3ikjoNGX1L8SlcV4ih2J+r2kSHjhkZ8c+wJE
# v2iiUHqpwmch31UwQOb4qklGKg1A+SAUGdf0cTTc6ApSFsqrol1euObreoy0zdAA
    Write-Output ""
    Write-Output "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
    Write-Output "  â„¹  Password exceptions exist. Whether they're acceptable"
    Write-Output "     requires governance review. Run IdentityHealthCheck."
    Write-Output "  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
# TrQgZiSoepcCjW2otZIXrmDnJ7BtqmmiRff4CCacdJXxqNWdFnv6y7Yy6DQmECEC
# AwEAAaNGMEQwDgYDVR0PAQH/BAQDAgeAMBMGA1UdJQQMMAoGCCsGAQUFBwMDMB0G
# A1UdDgQWBBQBfqZy0Xp6lbG6lqI+cAlT7ardlTANBgkqhkiG9w0BAQsFAAOCAgEA
# IwBi/lJTGag5ac5qkMcnyholdDD6H0OaBSFtux1vPIDqNd35IOGYBsquL0BZKh8O
# AHiuaKbo2Ykevpn5nzbXDBVHIW+gN1yu5fWCXSezCPN/NgVgdH6CQ6vIuKNq4BVm
# E8AEhm7dy4pm4WPLqEzWT2fwJhnJ8JYBnPbuUVE8F8acyqG8l3QMcGICG26NWgGs
# A28YvlkzZsny+HAzLvmJn/IhlfWte1kGu0h0G7/KQG6hei5afsn0HxWHKqxI9JsG
# EF3SsMVQW3YJtDzAiRkNtII5k0PyywjrgzIGViVNOrKMT9dKlsTev6Ca/xQX13xM
# 0prtnvxiTXGtT031EBGXAUhOzvx2Hp1WFnZTEIJyX1J2qI+DQsPb9Y1jWcdGBwv3
# /m1nAHE7FpPGsSv+UIP3QQFD/j6nLl5zUoWxqAZMcV4K4t4WkPQjPAXzomoRaqc6
# toXHlXhKHKZ0kfAIcPCFlMwY/Rho82GiATIxHXjB/911VRcpv+xBoPCZkXDnsr9k
# /aRuPNt9DDSrnocJIoTtqIdel/GJmD0D75Lg4voUX9J/1iBuUzta2hoBA8fSVPS5
# 6plrur3Sn5QQG2kJt9I4z5LS3UZSfT+29+xJz7WSyp8+LwU7jaNUuWr3lpUnY2nS
# pohDlw2BFFNGT6/DZ0loRJrUMt58UmfdUX8FPB7uNuIxggNIMIIDRAIBATCBlTCB
# gDELMAkGA1UEBhMCR0IxFzAVBgNVBAgMDk5vcnRodW1iZXJsYW5kMRcwFQYDVQQH
# DA5Ob3J0aHVtYmVybGFuZDEaMBgGA1UECgwRSWRlbnRpdHlGaXJzdCBMdGQxIzAh
# BgNVBAMMGklkZW50aXR5Rmlyc3QgQ29kZSBTaWduaW5nAhAxVnqog0nQoULr1Ync
# nW59MA0GCWCGSAFlAwQCAQUAoIGEMBgGCisGAQQBgjcCAQwxCjAIoAKAAKECgAAw
# GQYJKoZIhvcNAQkDMQwGCisGAQQBgjcCAQQwHAYKKwYBBAGCNwIBCzEOMAwGCisG
# AQQBgjcCARUwLwYJKoZIhvcNAQkEMSIEIFJRyEoDUk2RsejCLsyjdB9cDdPG2oH6
# j9ZtMdTgj9klMA0GCSqGSIb3DQEBAQUABIICAGi8M8lNFm9AJSfX5jmklgtounYP
# nboiOlDAmR5+YbsW9WZuYs7bXAYgs+/3MQjROqm5OGLrPpqllpY0aYwGFZ4f6njt
# 4X3z+R4EljLEAsXC7rBvA3mYIlO7Qy0gjFWtfnidWlEUejmsTTW/vBadTbwqaX3u
# x9jeZozxminX7fZGE81iOTuvOj5IvKt4o5yRj3S0yHM9Txukyjcx99PbfsYudl0O
# Jo2htzTah0yTo2DUdtdkVWOOQU+4bbkfNauxWjE3s8TgyyvpYYDHPRDB6vSxS48R
# W+jsxRY/Zp6iicUnkaLha59gX62aiQ8MPWjIJwQh6ucp/MT8wmzeWTgFn8nGDOZx
# 9RgaWwmL93TF8zVsbwa35PoYPJvbXi0jwwO5vSmR93p2FH5P+d0Z1UlJH8Gndk1s
# YN/tzbLrl+ylQrdz8cNDmA39LynXxfB6y5/BKTbrhCbzfMUk9J0a2Dw6LqmRHmNS
# alom8cLuIOZULnvXPZTGqJKy9k+IGBgupdoqZJt9Pdwq9x+oomfsZo36d0HCVSAW
# DzqWTIU4kd/aaimZ3UomOoEAvB1cyFFBa2KpKPbzBs0Dg/uJE/nuWusIEK5HT5lD
# Vhze/pF9gzLZrK2UAisgcLacZuGcs3+NXjpR+RzWDeA3JEQu0THVVOVKVvq5E/9m
# e+92tWxDkZO2XGqf
# SIG # End signature block
